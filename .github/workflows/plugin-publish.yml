name: Publish Plugin to Stores

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag to publish (e.g., plugin-v0.2.1)'
        required: true
        type: string

# Required GitHub Secrets:
# Mozilla Add-ons:
#   - AMO_JWT_ISSUER: Mozilla API JWT issuer
#   - AMO_JWT_SECRET: Mozilla API JWT secret
# Chrome Web Store:
#   - CHROME_EXTENSION_ID: Chrome extension ID
#   - CHROME_CLIENT_ID: Chrome OAuth client ID
#   - CHROME_CLIENT_SECRET: Chrome OAuth client secret
#   - CHROME_REFRESH_TOKEN: Chrome OAuth refresh token

jobs:
  submit-to-mozilla:
    name: Submit to Mozilla Add-ons
    runs-on: ubuntu-latest
    # Only run for plugin releases (not server/desktop) and not for pre-releases
    if: |
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'plugin-v') && !github.event.release.prerelease) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag_name, 'plugin-v'))
    permissions:
      contents: write  # For commenting on release

    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag_name }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION="${VERSION#plugin-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Download Firefox addon package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Downloading Firefox addon v${VERSION}..."
          curl -fL -o firefox-addon.zip \
            "https://github.com/${{ github.repository }}/releases/download/plugin-v${VERSION}/porua-extension-firefox-v${VERSION}.zip"

          echo "Downloading source code archive..."
          curl -fL -o source-code.zip \
            "https://github.com/${{ github.repository }}/releases/download/plugin-v${VERSION}/porua-extension-source-v${VERSION}.zip"

          echo "Downloading checksums..."
          curl -fL -o SHA256SUMS \
            "https://github.com/${{ github.repository }}/releases/download/plugin-v${VERSION}/SHA256SUMS"

          echo "Files downloaded:"
          ls -lh *.zip SHA256SUMS

      - name: Verify checksums
        run: |
          echo "Verifying file integrity..."
          sha256sum -c SHA256SUMS --ignore-missing
          echo "‚úì All checksums verified successfully"

      - name: Submit to Mozilla AMO
        id: amo_submit
        timeout-minutes: 10
        uses: browser-actions/release-firefox-addon@v0
        with:
          addon-id: 'porua'
          addon-path: firefox-addon.zip
          source-path: source-code.zip
          auth-api-issuer: ${{ secrets.AMO_JWT_ISSUER }}
          auth-api-secret: ${{ secrets.AMO_JWT_SECRET }}
          channel: listed
          approval-note: |
            Build instructions: See BUILD_INSTRUCTIONS.md in source archive.

            Extension connects to local Porua TTS server (default: http://localhost:8080).
            No external services or tracking. All processing is local.

            To build:
            1. npm install
            2. npm run build
            3. npm run package

            The extension uses esbuild to bundle JavaScript modules.
          release-note: |
            See full changelog: https://github.com/${{ github.repository }}/releases/tag/plugin-v${{ steps.version.outputs.version }}
        continue-on-error: true

      - name: Update release with submission status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.amo_submit.outcome }}';
            const version = '${{ steps.amo_submit.outputs.version }}';
            const versionId = '${{ steps.amo_submit.outputs.version-id }}';
            const editUrl = '${{ steps.amo_submit.outputs.version-edit-url }}';

            let statusMessage;
            if (status === 'success') {
              statusMessage = `## ü¶ä Mozilla Add-ons Submission\n\n` +
                     `‚úÖ Successfully submitted version **${version}** to Mozilla AMO\n\n` +
                     `**Status**: Pending review (typically 1-2 weeks)\n` +
                     `**Version ID**: ${versionId}\n` +
                     `**Manage version**: ${editUrl}\n\n` +
                     `### What happens next?\n` +
                     `- Mozilla reviewers will examine the code (usually takes 1-2 weeks)\n` +
                     `- You'll receive email notifications about the review status\n` +
                     `- Once approved, the update will be live on the Firefox Add-ons store\n\n` +
                     `### Need to make changes?\n` +
                     `Visit the [version management page](${editUrl}) to update metadata or respond to reviewers.`;
            } else {
              statusMessage = `## ü¶ä Mozilla Add-ons Submission\n\n` +
                     `‚ö†Ô∏è Automated submission encountered an issue.\n\n` +
                     `**Status**: Failed - manual submission required\n\n` +
                     `### Manual submission steps:\n` +
                     `1. Visit https://addons.mozilla.org/developers/addon/porua/versions/submit/\n` +
                     `2. Upload the Firefox addon: \`porua-extension-firefox-v${{ steps.version.outputs.version }}.zip\`\n` +
                     `3. Upload the source code: \`porua-extension-source-v${{ steps.version.outputs.version }}.zip\`\n` +
                     `4. Fill in the release notes and submit\n\n` +
                     `**Download packages from this release** (scroll to Assets section below)\n\n` +
                     `Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details.`;
            }

            // Get current release
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });

            // Append status message to release body
            const updatedBody = release.data.body + '\n\n---\n\n' + statusMessage;

            // Update release with new body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: updatedBody
            });

      - name: Output submission results
        if: always()
        run: |
          echo "==================================="
          echo "Mozilla AMO Submission Results"
          echo "==================================="
          echo "Status: ${{ steps.amo_submit.outcome }}"
          echo "Version: ${{ steps.amo_submit.outputs.version }}"
          echo "Version ID: ${{ steps.amo_submit.outputs.version-id }}"
          echo "Edit URL: ${{ steps.amo_submit.outputs.version-edit-url }}"
          echo "==================================="

  submit-to-chrome:
    name: Submit to Chrome Web Store
    runs-on: ubuntu-latest
    # Only run for plugin releases (not server/desktop) and not for pre-releases
    if: |
      (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'plugin-v') && !github.event.release.prerelease) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.tag_name, 'plugin-v'))
    permissions:
      contents: write  # For commenting on release

    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.tag_name }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          VERSION="${VERSION#plugin-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Download Chrome extension package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Downloading Chrome extension v${VERSION}..."
          curl -fL -O \
            "https://github.com/${{ github.repository }}/releases/download/plugin-v${VERSION}/porua-extension-chrome-v${VERSION}.zip"

          echo "Downloading checksums..."
          curl -fL -O \
            "https://github.com/${{ github.repository }}/releases/download/plugin-v${VERSION}/SHA256SUMS"

          echo "Files downloaded:"
          ls -lh *.zip SHA256SUMS

      - name: Verify checksums
        run: |
          echo "Verifying file integrity..."
          sha256sum -c SHA256SUMS --ignore-missing
          echo "‚úì All checksums verified successfully"

      - name: Upload to Chrome Web Store
        id: chrome_upload
        timeout-minutes: 10
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          file-path: porua-extension-chrome-v${{ steps.version.outputs.version }}.zip
          publish: false  # Stage the release, don't auto-publish
        continue-on-error: true

      - name: Update release with submission status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.chrome_upload.outcome }}';
            const version = '${{ steps.version.outputs.version }}';

            let statusMessage;
            if (status === 'success') {
              statusMessage = `## üåê Chrome Web Store Submission\n\n` +
                     `‚úÖ Successfully uploaded version **${version}** to Chrome Web Store\n\n` +
                     `**Status**: Staged for review (not published)\n` +
                     `**Extension ID**: ${{ secrets.CHROME_EXTENSION_ID }}\n` +
                     `**Developer Dashboard**: https://chrome.google.com/webstore/devconsole\n\n` +
                     `### What happens next?\n` +
                     `- Google will review the extension (typically within 24-72 hours)\n` +
                     `- You'll receive email notifications about the review status\n` +
                     `- Once approved, it will show "Ready to publish" in the dashboard\n` +
                     `- **You must manually click "Publish" to make it live**\n` +
                     `- You have 30 days to publish after approval, or it reverts to draft\n\n` +
                     `### Manual publish steps:\n` +
                     `1. Go to [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)\n` +
                     `2. Find your extension\n` +
                     `3. Once approved, click the "Publish" button\n` +
                     `4. The update will be live within a few hours`;
            } else {
              statusMessage = `## üåê Chrome Web Store Submission\n\n` +
                     `‚ö†Ô∏è Automated upload encountered an issue.\n\n` +
                     `**Status**: Failed - manual upload required\n\n` +
                     `### Manual upload steps:\n` +
                     `1. Visit [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)\n` +
                     `2. Click on your Porua extension\n` +
                     `3. Click "Package" ‚Üí "Upload new package"\n` +
                     `4. Upload the Chrome extension: \`porua-extension-chrome-v${version}.zip\`\n` +
                     `5. Fill in any required information\n` +
                     `6. Click "Submit for review"\n` +
                     `7. After approval, manually click "Publish"\n\n` +
                     `**Download package from this release** (scroll to Assets section below)\n\n` +
                     `Check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details.`;
            }

            // Get current release
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });

            // Append status message to release body
            const updatedBody = release.data.body + '\n\n---\n\n' + statusMessage;

            // Update release with new body
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: updatedBody
            });

      - name: Output submission results
        if: always()
        run: |
          echo "==================================="
          echo "Chrome Web Store Submission Results"
          echo "==================================="
          echo "Status: ${{ steps.chrome_upload.outcome }}"
          echo "Extension ID: ${{ secrets.CHROME_EXTENSION_ID }}"
          echo "==================================="
